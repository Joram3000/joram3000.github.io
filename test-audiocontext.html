<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AudioContext Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      #log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>AudioContext Fix Verification</h1>

    <div class="test-section">
      <h2>Test Results</h2>
      <div id="initialTest" class="status warning">
        üîÑ Testing initial state...
      </div>
      <div id="userInteractionTest" class="status warning">
        ‚è≥ Waiting for user interaction test...
      </div>
      <div id="regionTest" class="status warning">
        ‚è≥ Waiting for region functionality test...
      </div>
    </div>

    <div class="test-section">
      <h2>Manual Tests</h2>
      <button onclick="testUserInteraction()">Test User Interaction</button>
      <button onclick="testRegionFunctionality()">
        Test Region Functionality
      </button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
      <h2>Console Log</h2>
      <div id="log"></div>
    </div>

    <script>
      let audioContextCreated = false
      let userInteractionDetected = false
      const logDiv = document.getElementById("log")

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString()
        const logMessage = `[${timestamp}] ${message}`
        console.log(logMessage)
        logDiv.textContent += logMessage + "\n"
        logDiv.scrollTop = logDiv.scrollHeight
      }

      function updateStatus(elementId, message, type) {
        const element = document.getElementById(elementId)
        element.textContent = message
        element.className = `status ${type}`
      }

      function clearLog() {
        logDiv.textContent = ""
      }

      // Override AudioContext constructor to track creation
      const originalAudioContext = window.AudioContext
      const originalWebkitAudioContext = window.webkitAudioContext

      if (originalAudioContext) {
        window.AudioContext = function (...args) {
          audioContextCreated = true
          log("üéµ AudioContext created!", "success")
          return new originalAudioContext(...args)
        }
      }

      if (originalWebkitAudioContext) {
        window.webkitAudioContext = function (...args) {
          audioContextCreated = true
          log("üéµ webkitAudioContext created!", "success")
          return new originalWebkitAudioContext(...args)
        }
      }

      // Test 1: Initial state
      setTimeout(() => {
        if (!audioContextCreated) {
          updateStatus(
            "initialTest",
            "‚úÖ AudioContext NOT created on page load",
            "success",
          )
          log("‚úÖ Test 1 PASSED: AudioContext not created on page load")
        } else {
          updateStatus(
            "initialTest",
            "‚ùå AudioContext was created on page load",
            "error",
          )
          log("‚ùå Test 1 FAILED: AudioContext was created on page load")
        }
      }, 2000)

      // Test 2: User interaction
      function testUserInteraction() {
        log("üñ±Ô∏è Testing user interaction...")

        // Simulate clicking somewhere that should trigger AudioContext creation
        const event = new MouseEvent("click", {
          bubbles: true,
          cancelable: true,
          view: window,
        })
        document.body.dispatchEvent(event)

        setTimeout(() => {
          if (audioContextCreated) {
            updateStatus(
              "userInteractionTest",
              "‚úÖ AudioContext created after user interaction",
              "success",
            )
            log("‚úÖ Test 2 PASSED: AudioContext created after user interaction")
          } else {
            updateStatus(
              "userInteractionTest",
              "‚ö†Ô∏è AudioContext not created after user interaction",
              "warning",
            )
            log(
              "‚ö†Ô∏è Test 2 PARTIAL: AudioContext not created after user interaction (might need actual app interaction)",
            )
          }
        }, 1000)
      }

      // Test 3: Region functionality (placeholder)
      function testRegionFunctionality() {
        log("üéØ Testing region functionality...")

        // Check if we can access the main app's region functionality
        if (typeof window.WaveSurfer !== "undefined") {
          log("‚úÖ WaveSurfer is available")
          updateStatus(
            "regionTest",
            "‚úÖ WaveSurfer available, region functionality should work",
            "success",
          )
        } else {
          log("‚ö†Ô∏è WaveSurfer not directly accessible from test page")
          updateStatus(
            "regionTest",
            "‚ö†Ô∏è WaveSurfer not accessible from test page",
            "warning",
          )
        }
      }

      // Monitor console errors
      window.addEventListener("error", (event) => {
        if (event.message.includes("AudioContext")) {
          log(`‚ùå AudioContext error: ${event.message}`, "error")
        }
      })

      // Log initial state
      log("üöÄ AudioContext test initialized")
      log("üìä Monitoring AudioContext creation...")
    </script>
  </body>
</html>
